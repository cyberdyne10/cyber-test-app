<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Overall Certificate</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f8fafc;
      color: #1e293b;
      font-family: 'Times New Roman', serif;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .cert-frame {
      width: 100%;
      max-width: 800px;
      border: 10px solid #0f172a;
      padding: 10px;
      background: #fff;
    }
    .cert-inner {
      border: 2px solid #94a3b8;
      padding: 40px;
      text-align: center;
      position: relative;
    }
    .cert-logo {
      height: 80px;
      margin-bottom: 20px;
    }
    .cert-title {
      font-size: 2.6rem;
      font-weight: bold;
      color: #0f172a;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 10px;
    }
    .cert-subtitle {
      font-size: 1.1rem;
      color: #64748b;
      margin-bottom: 30px;
    }
    .cert-body {
      font-size: 1.3rem;
      line-height: 1.8;
      margin-bottom: 30px;
    }
    .student-name {
      font-weight: bold;
      font-size: 2rem;
      border-bottom: 2px solid #cbd5e1;
      padding-bottom: 5px;
      display: inline-block;
      min-width: 300px;
      margin: 0 10px;
      color: #0ea5e9;
    }
    .overall-score {
      font-size: 1.8rem;
      font-weight: bold;
      color: #0f172a;
      border: 2px solid #0f172a;
      display: inline-block;
      padding: 10px 30px;
      border-radius: 8px;
      margin-top: 10px;
    }
    .cert-footer {
      margin-top: 50px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 1rem;
    }
    .signature {
      width: 250px;
      text-align: center;
    }
    .signature-line {
      border-top: 1px solid #94a3b8;
      width: 70%;
      margin: 4px auto 8px auto;
    }
    .date-stamp {
      font-family: monospace;
      color: #64748b;
    }
    .summary-table {
      margin-top: 20px;
      font-size: 0.95rem;
    }
    @media print {
      body { background: none; padding: 0; }
      .cert-frame { border: 5px solid #000; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="cert-frame">
    <div class="cert-inner">
      <img src="logo-cyber-logic.png" class="cert-logo" alt="Logo">
      <div class="cert-title">Overall Performance Certificate</div>
      <div class="cert-subtitle">Cyber-Logic Network Exam Programme</div>

      <div class="cert-body">
        This is to certify that<br>
        <span class="student-name" id="sName">Student Name</span><br>
        has successfully completed multiple assessments on this platform<br>
        with an overall performance of
        <div class="overall-score" id="overallScore">--%</div>
        <div class="mt-3" style="font-size:1rem; color:#64748b;" id="metaLine"></div>
      </div>

      <div class="summary-table">
        <div class="fw-bold mb-2">Assessment Summary</div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Test</th>
                <th>Score</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
          </table>
        </div>
      </div>

      <div class="cert-footer">
        <div class="text-start">
          <div class="date-stamp" id="dateVal">Date: YYYY-MM-DD</div>
          <div style="font-size:0.8rem; margin-top:5px;">Student ID: <span id="studId">#</span></div>
        </div>
        <div class="signature">
          <img src="signature.png" style="height: 70px; display: block; margin: 0 auto 5px auto;">
          <div class="signature-line"></div>
          <div style="font-weight: bold; margin-bottom: 2px;">Engr. Lawrence Dimkpa</div>
          <div style="font-size: 0.9rem; color: #64748b;">Instructor / Administrator</div>
        </div>
      </div>
    </div>

    <div class="text-center mt-3 no-print">
      <button onclick="window.print()" class="btn btn-primary">Print / Save as PDF</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const studentId = params.get('student_id');

    if (!studentId) {
      document.body.innerHTML = '<div class="text-center p-5">Invalid Overall Certificate Link</div>';
    } else {
      const token = localStorage.getItem('adminAuthToken');
      const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};

      Promise.all([
        fetch('/api/students', { headers: authHeaders }).then(r => r.json()),
        fetch(`/api/student/${studentId}/history`, { headers: authHeaders }).then(r => r.json())
      ])
      .then(([students, attempts]) => {
        if (!Array.isArray(students) || !Array.isArray(attempts)) {
          document.body.innerHTML = '<div class="text-center p-5">Admin login required to view this certificate.</div>';
          return;
        }

        const s = students.find(x => x.id == studentId);
        if (!s) {
          document.body.innerHTML = '<div class="text-center p-5">Student not found.</div>';
          return;
        }
        const submitted = attempts.filter(a => a.status === 'submitted');
        if (!submitted.length) {
          document.getElementById('overallScore').textContent = '--';
          document.getElementById('metaLine').textContent = 'No completed assessments found.';
        } else {
          let totalPercent = 0;
          submitted.forEach(a => {
            if (a.total > 0) totalPercent += (a.score / a.total) * 100;
          });
          const overall = totalPercent / submitted.length;
          document.getElementById('overallScore').textContent = overall.toFixed(1) + '%';
          document.getElementById('metaLine').textContent = `Based on ${submitted.length} completed assessment(s).`;
        }

        document.getElementById('sName').textContent = s.name;
        document.getElementById('studId').textContent = s.reg_number || s.username;
        document.getElementById('dateVal').textContent = 'Date: ' + new Date().toLocaleDateString();

        const body = document.getElementById('summaryBody');
        body.innerHTML = '';
        if (!attempts.length) {
          body.innerHTML = '<tr><td colspan="3" class="text-center">No attempts yet.</td></tr>';
        } else {
          attempts.forEach(a => {
            const tr = document.createElement('tr');
            const pct = a.total > 0 ? ((a.score / a.total) * 100).toFixed(1) + '%' : '--';
            tr.innerHTML = `<td>${a.test_name}</td><td>${a.score}/${a.total} (${pct})</td><td>${new Date(a.created_at).toLocaleDateString()}</td>`;
            body.appendChild(tr);
          });
        }
      })
      .catch(err => {
        console.error(err);
        document.body.innerHTML = '<div class="text-center p-5">Error loading overall certificate.</div>';
      });
    }
  </script>
</body>
</html>
