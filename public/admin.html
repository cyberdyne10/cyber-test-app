<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cyber Test – Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ===== Clean white/gray admin dashboard theme ===== */
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Theme variables */
    :root {
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-2: #f8fafc;
      --border: #e5e7eb;
      --border-2: #eef2f7;
      --text: #0f172a;
      --muted: #64748b;
      --muted-2: #94a3b8;
      --primary: #6366f1;
      --primary-soft: #eef2ff;
      --shadow: 0 12px 34px rgba(15, 23, 42, 0.07);
    }

    body.admin-dark {
      --bg: #0b1220;
      --surface: rgba(15, 23, 42, 0.92);
      --surface-2: rgba(15, 23, 42, 0.70);
      --border: rgba(148, 163, 184, 0.18);
      --border-2: rgba(148, 163, 184, 0.14);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted-2: #94a3b8;
      --primary: #38bdf8;
      --primary-soft: rgba(56, 189, 248, 0.10);
      --shadow: 0 18px 50px rgba(0,0,0,0.45);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(56,189,248,0.12), transparent 60%),
                  radial-gradient(1000px 600px at 80% 20%, rgba(99,102,241,0.12), transparent 60%),
                  #070c16;
      color: var(--text);
    }

    /* Dark-mode fixes for form elements + file inputs (Bootstrap doesn't fully cover these) */
    body.admin-dark .form-control,
    body.admin-dark .form-select,
    body.admin-dark textarea,
    body.admin-dark input[type="file"] {
      background-color: rgba(2, 6, 23, 0.35) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }
    body.admin-dark .form-control::placeholder,
    body.admin-dark textarea::placeholder {
      color: rgba(148,163,184,0.85) !important;
    }
    body.admin-dark .input-group-text {
      background: rgba(2, 6, 23, 0.25) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }
    body.admin-dark .card-soft,
    body.admin-dark .kpi,
    body.admin-dark .admin-topbar,
    body.admin-dark .admin-sidebar {
      backdrop-filter: blur(8px);
    }
    body.admin-dark .btn-outline-primary,
    body.admin-dark .btn-outline-danger,
    body.admin-dark .btn-outline-warning,
    body.admin-dark .btn-outline-success,
    body.admin-dark .btn-outline-secondary {
      color: var(--text);
    }
    body.admin-dark .text-muted { color: var(--muted) !important; }
    body.admin-dark .badge.bg-warning.text-dark { color: #0b1220 !important; }


    .admin-shell {
      min-height: 100vh;
      display: flex;
    }

    .admin-sidebar {
      width: 260px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 18px 14px;
    }

    .admin-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      background: var(--surface-2);
      border: 1px solid var(--border-2);
      margin-bottom: 16px;
      text-align: center;
    }
    .admin-brand img {
      width: 54px;
      height: 54px;
      border-radius: 12px;
      object-fit: contain;
      background: var(--surface);
      padding: 6px;
      border: 1px solid var(--border);
    }
    .admin-brand .title {
      font-weight: 900;
      font-size: 1.05rem;
      line-height: 1.1;
      letter-spacing: -0.01em;
    }
    .admin-brand .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
      font-weight: 600;
    }

    .admin-nav {
      margin-top: 8px;
    }
    .admin-nav a {
      display: flex;
      position: relative;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      color: color-mix(in srgb, var(--text) 80%, transparent);
      text-decoration: none;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 6px;
      border: 1px solid transparent;
    }
    .admin-nav a .nav-left {
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .admin-nav a .nav-ico {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: color-mix(in srgb, var(--surface-2) 90%, transparent);
      border:1px solid var(--border);
      color: color-mix(in srgb, var(--text) 75%, transparent);
      flex: 0 0 auto;
    }
    .admin-nav a.active .nav-ico {
      background: color-mix(in srgb, var(--primary) 10%, var(--surface));
      border-color: color-mix(in srgb, var(--primary) 25%, var(--border));
      color: var(--primary);
    }
    .admin-nav a .nav-text {
      display:flex;
      flex-direction:column;
      line-height:1.1;
      min-width:0;
    }
    .admin-nav a .nav-text span {
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .admin-nav a small {
      font-weight: 700;
      color: var(--muted-2);
    }
    .admin-nav a:hover {
      background: var(--surface-2);
      border-color: var(--border-2);
    }
    .admin-nav a.active::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 8px;
      bottom: 8px;
      width: 4px;
      border-radius: 999px;
      background: var(--primary);
    }
    .admin-nav a.active {
      background: var(--primary-soft);
      border-color: color-mix(in srgb, var(--primary) 30%, var(--border));
      color: var(--text);
    }

    .admin-content {
      flex: 1;
      padding: 18px 22px;
    }

    .admin-topbar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    .admin-topbar .page-title {
      font-weight: 800;
      font-size: 1.05rem;
      margin: 0;
    }
    .admin-topbar .page-sub {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0;
      margin-top: 2px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.82rem;
      color: color-mix(in srgb, var(--text) 70%, transparent);
      white-space: nowrap;
    }

    .card-soft {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .admin-soft-panel {
      padding: 12px;
      background: var(--surface-2);
      border-color: var(--border-2);
    }

    .qb-question-item {
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-2);
      margin-bottom: 8px;
      cursor: pointer;
      background: var(--surface);
    }

    body.admin-dark .qb-question-item {
      border-color: var(--border);
    }

    body.admin-dark input[type="file"]::file-selector-button {
      background: rgba(2, 6, 23, 0.35);
      border: 1px solid var(--border);
      color: var(--text);
    }
    body.admin-dark input[type="file"]::-webkit-file-upload-button {
      background: rgba(2, 6, 23, 0.35);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .kpi {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .kpi .label {
      font-size: 0.82rem;
      color: var(--muted);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .kpi .value {
      font-size: 1.6rem;
      font-weight: 900;
      margin-top: 6px;
      color: var(--text);
    }
    .kpi .hint {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .hidden { display: none !important; }

    .table thead th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      border-bottom: 1px solid var(--border) !important;
    }
    .table td {
      border-top: 1px solid var(--border-2) !important;
      font-size: 0.9rem;
      color: var(--text);
    }

    .live-dot { height: 10px; width: 10px; background: #22c55e; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    /* Make bootstrap dark tables look clean on white */
    .table.table-dark {
      --bs-table-bg: transparent;
      --bs-table-color: var(--text);
      --bs-table-striped-color: var(--text);
      --bs-table-striped-bg: color-mix(in srgb, var(--text) 6%, transparent);
      --bs-table-hover-bg: color-mix(in srgb, var(--primary) 12%, transparent);
      --bs-table-hover-color: var(--text);
    }

    /* Login panel */
    .login-wrap {
      max-width: 520px;
      margin: 6vh auto 0;
    }
  </style>
</head>
<body>

  <!-- LOGIN VIEW (kept, just restyled) -->
  <div id="loginSection" class="login-wrap">
    <div class="card-soft">
      <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
        <div>
          <div style="font-weight:900; font-size:1.1rem;">Admin Console</div>
          <div class="text-muted" style="font-size:0.9rem;">Instructor access only.</div>
        </div>
        <span class="chip">Secure Area</span>
      </div>

      <div class="alert alert-warning" style="margin-top:12px; font-size:0.9rem;">
        Use your admin access phrase to unlock the dashboard.
      </div>

      <div class="mb-2">
        <label class="form-label">Admin Access Phrase</label>
        <input type="password" id="adminPassword" class="form-control" placeholder="Enter instructor phrase" />
      </div>
      <button id="loginBtn" class="btn btn-primary mt-2 w-100">Unlock Console</button>
      <div id="loginError" class="text-danger mt-2" style="display:none; font-size:0.9rem;">Incorrect phrase. Try again.</div>

      <div class="text-muted mt-3" style="font-size:0.85rem;">
        Tip: Keep the phrase private. Change it regularly in Settings.
      </div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="adminApp" class="admin-shell" style="display:none;">

    <!-- SIDEBAR -->
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <img src="logo-cyber-logic.png" alt="Cyber-Logic" />
        <div>
          <div class="title">Cyber Test Admin</div>
          <div class="subtitle">Assessment Control Room</div>
        </div>
      </div>

      <nav class="admin-nav">
        <a href="#" id="tab-dashboard" class="active"><div class="nav-left"><span class="nav-ico"><i class="bi bi-grid-1x2-fill"></i></span><div class="nav-text"><span>Dashboard</span><small>Overview</small></div></div></a>
        <a href="#" id="tab-manage"><div class="nav-left"><span class="nav-ico"><i class="bi bi-sliders"></i></span><div class="nav-text"><span>Manage Tests</span><small>Create/Edit</small></div></div></a>
        <a href="#" id="tab-questionbank"><div class="nav-left"><span class="nav-ico"><i class="bi bi-collection-fill"></i></span><div class="nav-text"><span>Question Bank</span><small>Import/Edit</small></div></div></a>
        <a href="#" id="tab-analytics"><div class="nav-left"><span class="nav-ico"><i class="bi bi-graph-up"></i></span><div class="nav-text"><span>Analytics/Results</span><small>Scores</small></div></div></a>
        <a href="#" id="tab-students"><div class="nav-left"><span class="nav-ico"><i class="bi bi-people-fill"></i></span><div class="nav-text"><span>Students</span><small>Registry</small></div></div></a>
        <a href="#" id="tab-live"><div class="nav-left"><span class="nav-ico"><i class="bi bi-broadcast"></i></span><div class="nav-text"><span>Live Monitor</span><small><span class="live-dot"></span></small></div></div></a>
        <a href="#" id="tab-settings"><div class="nav-left"><span class="nav-ico"><i class="bi bi-gear-fill"></i></span><div class="nav-text"><span>Settings</span><small>Security</small></div></div></a>
      </nav>

      <div class="mt-3">
        <button id="adminLogoutBtn" class="btn btn-outline-danger w-100">Logout</button>
      </div>

      <div class="text-muted mt-3" style="font-size:0.78rem; line-height:1.4;">
        Cyber-Logic Network Exam System • v1.0
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="admin-content">
      <div class="admin-topbar">
        <div>
          <p class="page-title" id="pageTitle">Dashboard</p>
          <p class="page-sub" id="pageSubtitle">Overview of tests, students, and activity.</p>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <button id="themeToggle" class="chip" type="button" title="Toggle dark mode">
            <i class="bi bi-moon-stars"></i>
            <span id="themeToggleText">Dark</span>
          </button>
          <span class="chip" id="adminHeaderStatus"><span style="font-weight:800;">Visibility</span> · Instructor Only</span>
        </div>
      </div>

      <div id="adminContent">

        <!-- DASHBOARD -->
        <div id="view-dashboard">
          <div class="row g-3 mb-3">
            <div class="col-md-3"><div class="kpi"><div class="label">Tests</div><div class="value" id="kpiTests">—</div><div class="hint">Configured exams</div></div></div>
            <div class="col-md-3"><div class="kpi"><div class="label">Students</div><div class="value" id="kpiStudents">—</div><div class="hint">Registered accounts</div></div></div>
            <div class="col-md-3"><div class="kpi"><div class="label">Active now</div><div class="value" id="kpiLive">—</div><div class="hint">In-progress attempts</div></div></div>
            <div class="col-md-3"><div class="kpi"><div class="label">Submissions</div><div class="value" id="kpiAttempts">—</div><div class="hint">Total submitted attempts</div></div></div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-lg-7">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="font-weight:900;">Attempts over time</div>
                  <span class="chip">Last 14 days</span>
                </div>
                <canvas id="chartAttempts" height="110"></canvas>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="font-weight:900;">Score distribution</div>
                  <span class="chip">Submitted</span>
                </div>
                <canvas id="chartScores" height="110"></canvas>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-7">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="font-weight:900;">Performance Overview</div>
                  <button class="btn btn-sm btn-outline-primary" id="dashRefreshBtn">Refresh</button>
                </div>
                <div id="analyticsGrid" class="row g-3"></div>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="font-weight:900;">Live Activity</div>
                  <button class="btn btn-sm btn-outline-primary" id="dashLiveRefreshBtn">Refresh</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-borderless align-middle">
                    <thead><tr><th>Student</th><th>Test</th><th>Viol.</th></tr></thead>
                    <tbody id="dashLiveBody"></tbody>
                  </table>
                </div>
                <div class="text-muted" style="font-size:0.85rem;">Tip: Use Live Monitor for full details.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- MANAGE TESTS -->
        <div id="view-manage" class="hidden">
          <div class="row g-3">
            <div class="col-lg-7">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="font-weight:900;">Create / Edit Test</div>
                  <span class="chip">Schedule + Access Key</span>
                </div>

                <div class="mb-3">
                  <label class="form-label">Test Name</label>
                  <input id="testName" class="form-control" placeholder="e.g. Network Security 101" />
                </div>
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea id="testDesc" class="form-control" placeholder="Short summary"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Instructions / Rules</label>
                  <textarea id="testInstructions" class="form-control" placeholder="e.g. No calculators allowed. Pass mark is 70%. "></textarea>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Duration (mins)</label>
                    <input id="testDuration" type="number" class="form-control" placeholder="30" />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Type</label>
                    <select id="testType" class="form-select">
                      <option value="exam">Standard Exam</option>
                      <option value="practice">Practice Mode</option>
                      <option value="mock">Mock Exam</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Questions / Attempt</label>
                    <input id="testSubset" type="number" class="form-control" placeholder="All" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Max Attempts</label>
                    <input id="testMaxAttempts" type="number" class="form-control" placeholder="Unlimited" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Access Key (Optional)</label>
                    <input id="testAccessKey" class="form-control" placeholder="e.g. SECURE99" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Start Time (Optional)</label>
                    <input id="testStartTime" type="datetime-local" class="form-control" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">End Time (Optional)</label>
                    <input id="testEndTime" type="datetime-local" class="form-control" />
                  </div>
                </div>

                <button id="createTestBtn" class="btn btn-primary">Save / Update Test</button>
              </div>
            </div>

            <div class="col-lg-5">
              <div class="card-soft">
                <div style="font-weight:900;" class="mb-2">Select Test</div>
                <div class="d-flex gap-2 align-items-center mb-3">
                  <select id="testsList" class="form-select"></select>
                  <button id="duplicateTestBtn" class="btn btn-sm btn-outline-primary" title="Duplicate Test">Copy</button>
                  <button id="deleteTestBtn" type="button" class="btn btn-sm btn-outline-danger" style="white-space:nowrap;">Delete</button>
                </div>

                <div class="text-muted" style="font-size:0.9rem;">
                  Use <b>Question Bank</b> to import/edit questions for the selected test.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- QUESTION BANK -->
        <div id="view-questionbank" class="hidden">
          <div class="row g-3">
            <div class="col-lg-5">
              <div class="card-soft">
                <div style="font-weight:900;" class="mb-2">Target Test</div>
                <div class="d-flex gap-2 align-items-center mb-3">
                  <select id="testsListQB" class="form-select"></select>
                  <button id="duplicateTestBtnQB" class="btn btn-sm btn-outline-primary" title="Duplicate Test">Copy</button>
                  <button id="deleteTestBtnQB" type="button" class="btn btn-sm btn-outline-danger" style="white-space:nowrap;">Delete</button>
                </div>

                <div class="card-soft admin-soft-panel">
                  <div style="font-weight:800;" class="mb-1">Bulk Import Questions (CSV)</div>
                  <div class="d-flex gap-2">
                    <input type="file" id="importFile" class="form-control" accept=".csv" />
                    <button id="importBtn" class="btn btn-outline-success">Upload</button>
                  </div>
                  <div class="text-muted" style="font-size:0.82rem; margin-top:8px;">Format: Text,Mark,Opt1,Opt2,Opt3,Opt4,CorrectIdx(1-4)</div>
                </div>

                <div class="mt-3">
                  <div style="font-weight:900;" class="mb-2">Questions</div>
                  <div class="card-soft" id="questionList" style="max-height: 330px; overflow-y:auto; padding: 10px;"></div>
                </div>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="font-weight:900;">Add / Edit Question</div>
                  <span class="chip">Single or Multiple Choice</span>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Question Type</label>
                    <select id="questionType" class="form-select">
                      <option value="single">Single Choice (Radio)</option>
                      <option value="multiple">Multiple Choice (Checkbox)</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Marks (Weight)</label>
                    <input id="questionMarks" type="number" class="form-control" value="1" placeholder="1" />
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Question Text</label>
                  <textarea id="questionText" class="form-control" placeholder="Type the full question"></textarea>
                </div>

                <div class="mb-3">
                  <label class="form-label">Image (Optional)</label>
                  <input type="file" id="questionImage" class="form-control" accept="image/*" />
                </div>

                <div class="mb-2" style="font-weight:800;">Options (check correct ones)</div>
                <div class="mb-3">
                  <div class="input-group mb-2">
                    <div class="input-group-text"><input class="form-check-input mt-0" type="checkbox" id="check1"></div>
                    <input id="opt1" class="form-control" placeholder="Option 1">
                  </div>
                  <div class="input-group mb-2">
                    <div class="input-group-text"><input class="form-check-input mt-0" type="checkbox" id="check2"></div>
                    <input id="opt2" class="form-control" placeholder="Option 2">
                  </div>
                  <div class="input-group mb-2">
                    <div class="input-group-text"><input class="form-check-input mt-0" type="checkbox" id="check3"></div>
                    <input id="opt3" class="form-control" placeholder="Option 3">
                  </div>
                  <div class="input-group mb-2">
                    <div class="input-group-text"><input class="form-check-input mt-0" type="checkbox" id="check4"></div>
                    <input id="opt4" class="form-control" placeholder="Option 4">
                  </div>
                </div>

                <div class="d-flex gap-2 align-items-center">
                  <button id="addQuestionBtn" class="btn btn-outline-primary">Add Question</button>
                  <!-- cancelEditBtn will be injected by JS when editing -->
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="view-analytics" class="hidden">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div style="font-weight:900; font-size:1.05rem;">Analytics & Results</div>
            <button id="downloadCsvBtn" class="btn btn-outline-success">Download Full CSV Export</button>
          </div>

          <div class="card-soft mb-3">
            <div class="text-muted" style="font-size:0.9rem;">Click a card to jump to its test in Manage Tests.</div>
            <div id="analyticsGrid2" class="row g-3 mt-1"></div>
          </div>

          <div class="card-soft">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div style="font-weight:900;">Submitted Attempts</div>
            </div>
            <div class="mb-3">
              <input id="attemptFilter" class="form-control" placeholder="Filter by student name or test name" />
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-borderless align-middle">
                <thead>
                  <tr>
                    <th>Student</th><th>Test</th><th>Score</th><th>Violations</th><th>Time</th>
                  </tr>
                </thead>
                <tbody id="attemptsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- STUDENTS TAB -->
        <div id="view-students" class="hidden">
          <div class="card-soft">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div style="font-weight:900; font-size:1.05rem;">Registered Students</div>
            </div>
            <div class="mb-3">
              <input id="studentFilter" class="form-control" placeholder="Filter by full name, username, or reg no" />
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-borderless align-middle">
                <thead>
                  <tr>
                    <th>Reg No</th>
                    <th>Full Name</th>
                    <th>Username</th>
                    <th>Certificates</th>
                    <th class="text-end">Action</th>
                  </tr>
                </thead>
                <tbody id="studentsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- LIVE MONITOR TAB -->
        <div id="view-live" class="hidden">
          <div class="card-soft">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div style="font-weight:900; font-size:1.05rem;">Live Monitor <span class="live-dot" style="margin-left:6px;"></span></div>
              <button id="liveRefreshBtn" class="btn btn-outline-primary btn-sm">Refresh</button>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-borderless align-middle">
                <thead>
                  <tr>
                    <th>Student</th><th>Test</th><th>Started At</th><th>Violations</th><th>Status</th>
                  </tr>
                </thead>
                <tbody id="liveBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="view-settings" class="hidden">
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card-soft">
                <div style="font-weight:900;" class="mb-2">Security</div>
                <div class="mb-3">
                  <label class="form-label">Change Admin Access Phrase</label>
                  <input id="adminPhraseSetting" class="form-control" placeholder="Enter new admin phrase" />
                </div>
                <button id="updateAdminPhraseBtn" class="btn btn-outline-primary">Update Phrase</button>
                <div class="text-muted mt-2" style="font-size:0.85rem;">Requires current phrase confirmation.</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    const loginSection = document.getElementById('loginSection');
    const adminApp = document.getElementById('adminApp');
    const adminContent = document.getElementById('adminContent');
    const loginError = document.getElementById('loginError');
    const loginBtn = document.getElementById('loginBtn');
    const ADMIN_TOKEN_KEY = 'adminAuthToken';

    function getAdminToken() { return localStorage.getItem(ADMIN_TOKEN_KEY); }
    function setAdminToken(token) { localStorage.setItem(ADMIN_TOKEN_KEY, token); }
    function clearAdminToken() { localStorage.removeItem(ADMIN_TOKEN_KEY); }

    // Theme toggle
    const THEME_KEY = 'cln_admin_theme';
    function applyTheme(theme) {
      const isDark = theme === 'dark';
      document.body.classList.toggle('admin-dark', isDark);
      // Let Bootstrap 5.3 theme its components (inputs, selects, etc.)
      document.documentElement.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');

      const t = document.getElementById('themeToggleText');
      const ico = document.querySelector('#themeToggle i');
      if (t) t.textContent = isDark ? 'Light' : 'Dark';
      if (ico) ico.className = isDark ? 'bi bi-sun' : 'bi bi-moon-stars';
    }
    function getTheme() {
      return localStorage.getItem(THEME_KEY) || 'light';
    }
    function setTheme(theme) {
      localStorage.setItem(THEME_KEY, theme);
      applyTheme(theme);
    }

    async function apiFetch(url, options = {}) {
      const headers = new Headers(options.headers || {});
      const token = getAdminToken();
      if (token) headers.set('Authorization', `Bearer ${token}`);
      const res = await fetch(url, { ...options, headers });
      if (res.status === 401 || res.status === 403) {
        clearAdminToken();
        loginSection.style.display = 'block';
        adminApp.style.display = 'none';
      }
      return res;
    }

    document.getElementById('adminLogoutBtn').addEventListener('click', () => {
      clearAdminToken();
      window.location.href = '/';
    });

    // Views/Tabs
    const views = ['view-dashboard','view-manage','view-questionbank','view-analytics','view-students','view-live','view-settings'];
    const tabs  = ['tab-dashboard','tab-manage','tab-questionbank','tab-analytics','tab-students','tab-live','tab-settings'];

    function setHeader(title, sub) {
      document.getElementById('pageTitle').textContent = title;
      document.getElementById('pageSubtitle').textContent = sub;
    }

    function switchTab(idx) {
      views.forEach((v, i) => {
        document.getElementById(v).classList.toggle('hidden', i !== idx);
        document.getElementById(tabs[i]).classList.toggle('active', i === idx);
      });

      if (idx === 0) { setHeader('Dashboard','Overview of tests, students, and activity.'); loadDashboard(); }
      if (idx === 1) { setHeader('Manage Tests','Create, schedule, and configure exams.'); }
      if (idx === 2) { setHeader('Question Bank','Import and edit questions for a test.'); }
      if (idx === 3) { setHeader('Analytics/Results','Scores, attempts, and CSV export.'); loadAnalytics(true); loadAttempts(); }
      if (idx === 4) { setHeader('Students','Manage registered students.'); loadStudents(); }
      if (idx === 5) { setHeader('Live Monitor','See active students and violations in real time.'); loadLive(); }
      if (idx === 6) { setHeader('Settings','Security and admin access settings.'); }
    }

    tabs.forEach((t, i) => document.getElementById(t).addEventListener('click', (e) => { e.preventDefault(); switchTab(i); }));

    // Login Logic (SERVER SIDE)
    loginBtn.addEventListener('click', async () => {
      const password = document.getElementById('adminPassword').value;
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ password })
        });
        const data = await res.json();

        if (data.success && data.token) {
          setAdminToken(data.token);
          loginError.style.display = 'none';
          loginSection.style.display = 'none';
          adminApp.style.display = 'flex';
          initAdmin();
        } else {
          loginError.style.display = 'block';
        }
      } catch (e) {
        alert('Server error checking password');
      }
    });

    // Shared state
    let editingQuestionId = null;
    let _analyticsStats = [];
    let _attemptsCache = [];

    // Test list population (we maintain TWO selects: Manage + Question Bank)
    async function loadTestsIntoSelect(selectEl, { includeEmpty = false } = {}) {
      const res = await apiFetch('/api/tests');
      const tests = await res.json();
      selectEl.innerHTML = '';
      if (includeEmpty) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- select --';
        selectEl.appendChild(opt);
      }
      tests.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        selectEl.appendChild(opt);
      });
      return tests;
    }

    async function loadTestDetails(testId) {
      cancelEdit();
      const resMeta = await apiFetch(`/api/tests/${testId}/info`);
      const meta = await resMeta.json();
      if (meta) {
        document.getElementById('testName').value = meta.name;
        document.getElementById('testDesc').value = meta.description || '';
        document.getElementById('testInstructions').value = meta.instructions || '';
        document.getElementById('testDuration').value = meta.duration_minutes || '';
        document.getElementById('testType').value = meta.type || 'exam';
        document.getElementById('testSubset').value = meta.questions_per_attempt || '';
        document.getElementById('testMaxAttempts').value = meta.max_attempts || '';
        document.getElementById('testAccessKey').value = meta.access_key || '';

        const startInput = document.getElementById('testStartTime');
        const endInput = document.getElementById('testEndTime');
        if (meta.start_time) {
          const d = new Date(meta.start_time);
          const off = d.getTimezoneOffset();
          const local = new Date(d.getTime() - off * 60000);
          startInput.value = local.toISOString().slice(0, 16);
        } else {
          startInput.value = '';
        }
        if (meta.end_time) {
          const d = new Date(meta.end_time);
          const off = d.getTimezoneOffset();
          const local = new Date(d.getTime() - off * 60000);
          endInput.value = local.toISOString().slice(0, 16);
        } else {
          endInput.value = '';
        }
      }

      // Load question list into QB panel
      const res = await apiFetch(`/api/tests/${testId}/questions-full`);
      const questions = await res.json();
      const container = document.getElementById('questionList');
      container.innerHTML = '';

      if (!questions.length) {
        container.innerHTML = '<div class="text-muted" style="font-size:0.9rem;">No questions yet for this test.</div>';
        return;
      }

      questions.forEach(q => {
        const item = document.createElement('div');
        item.className = 'qb-question-item d-flex justify-content-between align-items-center';

        item.onclick = (e) => {
          if (e.target.tagName === 'BUTTON') return;
          editQuestion(q);
        };

        const txt = document.createElement('div');
        txt.style.fontWeight = '700';
        txt.style.fontSize = '0.92rem';
        txt.textContent = `[${q.marks} pts] ${q.text}`;

        const sub = document.createElement('div');
        sub.className = 'text-muted';
        sub.style.fontSize = '0.82rem';
        sub.textContent = (q.question_type || 'single') === 'multiple' ? 'Multiple choice' : 'Single choice';
        if (q.image_url) sub.textContent += ' • Has image';

        const left = document.createElement('div');
        left.appendChild(txt);
        left.appendChild(sub);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'btn btn-sm btn-outline-danger';
        delBtn.onclick = async (e) => {
          e.stopPropagation();
          if(!confirm('Delete this question?')) return;
          await apiFetch(`/api/questions/${q.id}`, { method: 'DELETE' });
          loadTestDetails(testId);
        };

        item.appendChild(left);
        item.appendChild(delBtn);
        container.appendChild(item);
      });
    }

    function editQuestion(q) {
      editingQuestionId = q.question_id || q.id;
      document.getElementById('questionText').value = q.text || q.question_text;
      document.getElementById('questionMarks').value = q.marks;
      document.getElementById('questionType').value = q.question_type || 'single';

      [1,2,3,4].forEach(i => {
        document.getElementById('opt'+i).value = '';
        document.getElementById('check'+i).checked = false;
        document.getElementById('opt'+i).dataset.id = '';
      });

      if (q.options && q.options.length > 0) {
        q.options.forEach((opt, idx) => {
          if (idx < 4) {
            const i = idx + 1;
            document.getElementById('opt'+i).value = opt.text || opt.option_text;
            document.getElementById('check'+i).checked = !!opt.is_correct;
            document.getElementById('opt'+i).dataset.id = opt.id || opt.option_id;
          }
        });
      }

      const btn = document.getElementById('addQuestionBtn');
      btn.textContent = 'Update Question';
      btn.className = 'btn btn-warning';

      let cancelBtn = document.getElementById('cancelEditBtn');
      if (!cancelBtn) {
        cancelBtn = document.createElement('button');
        cancelBtn.id = 'cancelEditBtn';
        cancelBtn.className = 'btn btn-outline-secondary';
        cancelBtn.textContent = 'Cancel Edit';
        cancelBtn.onclick = cancelEdit;
        btn.parentNode.appendChild(cancelBtn);
      }

      document.getElementById('questionText').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
      editingQuestionId = null;
      document.getElementById('questionText').value = '';
      document.getElementById('questionMarks').value = '1';
      document.getElementById('questionType').value = 'single';
      document.getElementById('questionImage').value = '';
      [1,2,3,4].forEach(i => {
        document.getElementById('opt'+i).value = '';
        document.getElementById('check'+i).checked = false;
        delete document.getElementById('opt'+i).dataset.id;
      });
      const btn = document.getElementById('addQuestionBtn');
      btn.textContent = 'Add Question';
      btn.className = 'btn btn-outline-primary';
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (cancelBtn) cancelBtn.remove();
    }

    function focusManageForTest(testId) {
      switchTab(1);
      const list = document.getElementById('testsList');
      list.value = String(testId);
      loadTestDetails(testId);
    }

    function renderAnalyticsCards(stats, targetGridEl) {
      targetGridEl.innerHTML = '';
      stats.forEach(s => {
        const col = document.createElement('div');
        col.className = 'col-md-6';
        const card = document.createElement('div');
        card.className = 'kpi';
        card.style.cursor = 'pointer';
        card.innerHTML = `
          <div class="label">${(s.name || 'Test').toString()}</div>
          <div class="value" style="font-size:1.2rem;">${s.attempts || 0} attempts</div>
          <div class="hint">Avg score: ${s.avg_score ? parseFloat(s.avg_score).toFixed(1) : '-'} / ${s.avg_total ? parseFloat(s.avg_total).toFixed(1) : '-'}</div>
        `;
        card.addEventListener('click', () => s.id && focusManageForTest(s.id));
        col.appendChild(card);
        targetGridEl.appendChild(col);
      });
    }

    async function loadAnalytics(renderToAnalyticsView = false) {
      const res = await apiFetch('/api/analytics');
      _analyticsStats = await res.json();

      // Dashboard grid
      const dashGrid = document.getElementById('analyticsGrid');
      if (dashGrid) renderAnalyticsCards(_analyticsStats, dashGrid);

      // Analytics view grid
      if (renderToAnalyticsView) {
        const grid2 = document.getElementById('analyticsGrid2');
        if (grid2) renderAnalyticsCards(_analyticsStats, grid2);
      }
    }

    function renderAttempts(filterText = '') {
      const body = document.getElementById('attemptsBody');
      body.innerHTML = '';
      const q = filterText.trim().toLowerCase();
      const rows = q
        ? _attemptsCache.filter(a =>
            (a.student_name || '').toLowerCase().includes(q) ||
            (a.test_name || '').toLowerCase().includes(q)
          )
        : _attemptsCache;

      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No attempts match this filter.</td></tr>';
        return;
      }

      rows.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.student_name}</td>
          <td>${a.test_name}</td>
          <td><b>${a.score}</b> / ${a.total}</td>
          <td>${a.violations > 0 ? `<span class="text-danger fw-bold">${a.violations}</span>` : '-'}</td>
          <td>${new Date(a.created_at).toLocaleString()}</td>
        `;
        body.appendChild(tr);
      });
    }

    async function loadAttempts() {
      const res = await apiFetch('/api/attempts');
      _attemptsCache = await res.json();
      renderAttempts(document.getElementById('attemptFilter')?.value || '');
    }

    let _studentsById = {};

    async function loadStudents() {
      const res = await apiFetch('/api/students');
      const students = await res.json();
      _studentsById = {};
      (students || []).forEach(st => { if (st && st.id != null) _studentsById[String(st.id)] = st; });
      const body = document.getElementById('studentsBody');
      body.innerHTML = '';
      students.forEach(s => {
        const tr = document.createElement('tr');
        const overallLink = `overall-certificate.html?student_id=${s.id}`;
        tr.innerHTML = `
          <td class="text-primary fw-bold">${s.reg_number || '-'}</td>
          <td>
            <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
              <span>${s.name}</span>
              <button class="btn btn-sm btn-outline-secondary" onclick="editStudentName(${s.id})">Edit</button>
            </div>
          </td>
          <td>${s.username}${Number(s.must_change_password || 0) === 1 ? ' <span class="badge bg-warning text-dark">Reset Required</span>' : ''}</td>
          <td><a href="${overallLink}" target="_blank" class="btn btn-sm btn-outline-primary">Overall Certificate</a></td>
          <td class="text-end d-flex gap-2 justify-content-end">
            <button class="btn btn-sm btn-outline-warning" onclick="resetStudentPassword(${s.id})">Reset Password</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${s.id})">Delete</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    async function editStudentName(id) {
      const cur = _studentsById[String(id)]?.name || '';
      const nextName = prompt('Enter the new full name for this student:', cur);
      if (nextName == null) return;

      const cleaned = String(nextName).trim();
      if (!cleaned) {
        alert('Name cannot be empty.');
        return;
      }

      // Use POST for maximum compatibility (some proxies block PUT)
      const res = await apiFetch(`/api/students/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: cleaned })
      });

      let data = {};
      try { data = await res.json(); } catch (e) { data = {}; }

      if (!res.ok) {
        const msg = data?.error || `Failed to update name (HTTP ${res.status})`;
        alert(msg);
        return;
      }

      loadStudents();
    }

    async function resetStudentPassword(id) {
      const newPassword = prompt('Enter temporary password for this student (minimum 8 characters):');
      if (!newPassword) return;

      const res = await apiFetch(`/api/students/${id}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword })
      });

      const data = await res.json();
      if (!res.ok) {
        alert(data.error || 'Failed to reset password');
        return;
      }

      alert('Password reset successful. Student will be forced to change password after login.');
      loadStudents();
    }

    async function deleteStudent(id) {
      if (!confirm('Delete this student account? They will lose access.')) return;
      await apiFetch(`/api/students/${id}`, { method: 'DELETE' });
      loadStudents();
    }

    async function loadLive() {
      const res = await apiFetch('/api/live');
      const live = await res.json();
      const body = document.getElementById('liveBody');
      body.innerHTML = '';
      if (live.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No active students right now.</td></tr>';
        return;
      }
      live.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${l.student_name}</td>
          <td>${l.test_name}</td>
          <td>${new Date(l.created_at).toLocaleTimeString()}</td>
          <td>${l.violations}</td>
          <td><span class="badge bg-success">Active</span></td>
        `;
        body.appendChild(tr);
      });
    }


    let _chartAttempts = null;
    let _chartScores = null;

    function destroyCharts() {
      try { if (_chartAttempts) _chartAttempts.destroy(); } catch(e) {}
      try { if (_chartScores) _chartScores.destroy(); } catch(e) {}
      _chartAttempts = null;
      _chartScores = null;
    }

    function renderCharts(attempts) {
      if (!window.Chart) return;
      const submitted = (attempts || []).filter(a => a && a.status === 'submitted');

      const days = 14;
      const labels = [];
      const counts = [];
      const today = new Date();
      const start = new Date(today);
      start.setDate(start.getDate() - (days - 1));

      const key = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return y + '-' + m + '-' + dd;
      };

      const bucket = new Map();
      for (let i=0;i<days;i++) {
        const d = new Date(start);
        d.setDate(start.getDate()+i);
        const k = key(d);
        bucket.set(k, 0);
        labels.push(d.toLocaleDateString(undefined,{month:'short',day:'2-digit'}));
      }

      submitted.forEach(a => {
        const d = new Date(a.created_at);
        const k = key(d);
        if (bucket.has(k)) bucket.set(k, bucket.get(k) + 1);
      });

      counts.push(...Array.from(bucket.values()));

      const distLabels = ['0-9','10-19','20-29','30-39','40-49','50-59','60-69','70-79','80-89','90-100'];
      const dist = new Array(distLabels.length).fill(0);
      submitted.forEach(a => {
        const total = Number(a.total || 0);
        const score = Number(a.score || 0);
        if (!total) return;
        const pct = Math.round((score/total) * 100);
        const idx = pct >= 90 ? 9 : Math.floor(pct/10);
        dist[Math.max(0, Math.min(9, idx))]++;
      });

      destroyCharts();

      const ctx1 = document.getElementById('chartAttempts');
      if (ctx1) {
        _chartAttempts = new Chart(ctx1, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Submissions',
              data: counts,
              borderColor: '#6366f1',
              backgroundColor: 'rgba(99,102,241,0.14)',
              tension: 0.35,
              fill: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: { grid: { color: 'rgba(15,23,42,0.06)' }, ticks: { precision: 0 } }
            }
          }
        });
      }

      const ctx2 = document.getElementById('chartScores');
      if (ctx2) {
        _chartScores = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: distLabels,
            datasets: [{
              label: 'Students',
              data: dist,
              backgroundColor: 'rgba(2,132,199,0.25)',
              borderColor: '#0284c7',
              borderWidth: 1,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: { grid: { color: 'rgba(15,23,42,0.06)' }, ticks: { precision: 0 } }
            }
          }
        });
      }
    }

    async function loadDashboard() {
      // KPIs
      const [testsRes, studentsRes, liveRes, attemptsRes] = await Promise.all([
        apiFetch('/api/tests'),
        apiFetch('/api/students'),
        apiFetch('/api/live'),
        apiFetch('/api/attempts')
      ]);

      const tests = await testsRes.json();
      const students = await studentsRes.json();
      const live = await liveRes.json();
      const attempts = await attemptsRes.json();

      renderCharts(attempts);

      document.getElementById('kpiTests').textContent = Array.isArray(tests) ? tests.length : '—';
      document.getElementById('kpiStudents').textContent = Array.isArray(students) ? students.length : '—';
      document.getElementById('kpiLive').textContent = Array.isArray(live) ? live.length : '—';
      document.getElementById('kpiAttempts').textContent = Array.isArray(attempts) ? attempts.length : '—';

      // Mini live table
      const dashLiveBody = document.getElementById('dashLiveBody');
      dashLiveBody.innerHTML = '';
      const top = (Array.isArray(live) ? live.slice(0, 6) : []);
      if (!top.length) {
        dashLiveBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No active students</td></tr>';
      } else {
        top.forEach(l => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${l.student_name}</td><td>${l.test_name}</td><td>${l.violations}</td>`;
          dashLiveBody.appendChild(tr);
        });
      }

      await loadAnalytics(false);
    }

    function initAdmin() {
      // Show app
      loginSection.style.display = 'none';
      adminApp.style.display = 'flex';

      // Apply theme + wire toggle
      applyTheme(getTheme());
      const themeBtn = document.getElementById('themeToggle');
      if (themeBtn) {
        themeBtn.addEventListener('click', () => {
          const next = document.body.classList.contains('admin-dark') ? 'light' : 'dark';
          setTheme(next);
        });
      }

      // Dashboard refresh buttons
      document.getElementById('dashRefreshBtn').addEventListener('click', loadDashboard);
      document.getElementById('dashLiveRefreshBtn').addEventListener('click', loadDashboard);

      document.getElementById('liveRefreshBtn').addEventListener('click', loadLive);

      // CSV Export
      document.getElementById('downloadCsvBtn').addEventListener('click', async () => {
        const res = await apiFetch('/api/export/csv');
        if (!res.ok) {
          alert('Failed to download CSV export');
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'exam_results.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      const attemptFilterInput = document.getElementById('attemptFilter');
      if (attemptFilterInput) {
        attemptFilterInput.addEventListener('input', (e) => renderAttempts(e.target.value || ''));
      }

      // Update Admin Password (SERVER SIDE)
      document.getElementById('updateAdminPhraseBtn').addEventListener('click', async () => {
        const newPassword = document.getElementById('adminPhraseSetting').value.trim();
        if (!newPassword) {
          alert('Enter a new admin phrase');
          return;
        }
        const currentPassword = prompt('Enter current admin phrase to confirm change:');
        if (!currentPassword) return;

        const res = await apiFetch('/api/admin/update-password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Unable to update admin phrase');
          return;
        }

        document.getElementById('adminPhraseSetting').value = '';
        alert('Admin phrase updated.');
      });

      // Create/Update Test
      document.getElementById('createTestBtn').addEventListener('click', async () => {
        const startVal = document.getElementById('testStartTime').value;
        const endVal = document.getElementById('testEndTime').value;
        let start_time = null;
        let end_time = null;
        if (startVal) start_time = new Date(startVal).toISOString();
        if (endVal) end_time = new Date(endVal).toISOString();

        const payload = {
          name: document.getElementById('testName').value,
          description: document.getElementById('testDesc').value,
          instructions: document.getElementById('testInstructions').value,
          duration_minutes: document.getElementById('testDuration').value,
          type: document.getElementById('testType').value,
          questions_per_attempt: document.getElementById('testSubset').value,
          max_attempts: document.getElementById('testMaxAttempts').value,
          access_key: document.getElementById('testAccessKey').value,
          start_time,
          end_time
        };

        const currentTestId = document.getElementById('testsList').value;
        if (currentTestId) {
          await apiFetch(`/api/tests/${currentTestId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        } else {
          await apiFetch('/api/tests', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        }
        alert('Test saved');
        await refreshAllTestSelectors();
      });

      // Import CSV
      document.getElementById('importBtn').addEventListener('click', async () => {
        const file = document.getElementById('importFile').files[0];
        const testId = document.getElementById('testsListQB').value;
        if (!file) return alert('Select a file');
        if (!testId) return alert('Select a test');
        const fd = new FormData();
        fd.append('file', file);
        const res = await apiFetch(`/api/tests/${testId}/import`, { method: 'POST', body: fd });
        const data = await res.json();
        alert('Imported ' + data.count + ' questions');
        loadTestDetails(testId);
      });

      // Add / Update Question
      document.getElementById('addQuestionBtn').addEventListener('click', async () => {
        const testId = document.getElementById('testsListQB').value;
        if (!testId) return alert('Select a test first.');

        const text = document.getElementById('questionText').value;
        const marks = document.getElementById('questionMarks').value;
        const qType = document.getElementById('questionType').value;
        const file = document.getElementById('questionImage').files[0];

        const options = [1,2,3,4].map(i => {
          const obj = {
            text: document.getElementById('opt'+i).value,
            is_correct: document.getElementById('check'+i).checked
          };
          const oid = document.getElementById('opt'+i).dataset.id;
          if (oid) obj.id = parseInt(oid);
          return obj;
        });

        if (editingQuestionId) {
          const payload = { text, marks, question_type: qType, options };
          await apiFetch(`/api/questions/${editingQuestionId}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });
          alert('Question updated');
          cancelEdit();
        } else {
          const fd = new FormData();
          fd.append('text', text);
          fd.append('marks', marks);
          fd.append('question_type', qType);
          fd.append('options', JSON.stringify(options));
          if (file) fd.append('image', file);

          await apiFetch(`/api/tests/${testId}/questions`, { method: 'POST', body: fd });
          alert('Question added');

          document.getElementById('questionText').value = '';
          document.getElementById('questionImage').value = '';
          [1,2,3,4].forEach(i => {
            document.getElementById('opt'+i).value = '';
            document.getElementById('check'+i).checked = false;
          });
        }
        loadTestDetails(testId);
      });

      // Duplicate/Delete (Manage)
      document.getElementById('duplicateTestBtn').onclick = async () => {
        const id = document.getElementById('testsList').value;
        if(!id) return;
        if(confirm('Duplicate this test?')) {
          await apiFetch(`/api/tests/${id}/duplicate`, { method: 'POST' });
          alert('Duplicated');
          await refreshAllTestSelectors();
        }
      };

      document.getElementById('deleteTestBtn').onclick = async () => {
        const id = document.getElementById('testsList').value;
        if(!id) return;
        if(confirm('Delete this test (and its questions)?')) {
          await apiFetch(`/api/tests/${id}`, { method: 'DELETE' });
          await refreshAllTestSelectors();
        }
      };

      // Duplicate/Delete (Question Bank)
      document.getElementById('duplicateTestBtnQB').onclick = async () => {
        const id = document.getElementById('testsListQB').value;
        if(!id) return;
        if(confirm('Duplicate this test?')) {
          await apiFetch(`/api/tests/${id}/duplicate`, { method: 'POST' });
          alert('Duplicated');
          await refreshAllTestSelectors();
        }
      };

      document.getElementById('deleteTestBtnQB').onclick = async () => {
        const id = document.getElementById('testsListQB').value;
        if(!id) return;
        if(confirm('Delete this test (and its questions)?')) {
          await apiFetch(`/api/tests/${id}`, { method: 'DELETE' });
          await refreshAllTestSelectors();
        }
      };

      // Keep QB and Manage selectors in sync
      document.getElementById('testsList').addEventListener('change', (e) => {
        const v = e.target.value;
        document.getElementById('testsListQB').value = v;
        if (v) loadTestDetails(v);
      });
      document.getElementById('testsListQB').addEventListener('change', (e) => {
        const v = e.target.value;
        document.getElementById('testsList').value = v;
        if (v) loadTestDetails(v);
      });

      // First load
      refreshAllTestSelectors().then(() => {
        switchTab(0);
      });

      // Auto refresh live monitor (best effort)
      setInterval(() => {
        const liveViewVisible = !document.getElementById('view-live').classList.contains('hidden');
        if (liveViewVisible) loadLive();
      }, 2500);
    }

    async function refreshAllTestSelectors() {
      const selManage = document.getElementById('testsList');
      const selQB = document.getElementById('testsListQB');
      const tests = await loadTestsIntoSelect(selManage);
      await loadTestsIntoSelect(selQB);

      const firstId = tests && tests.length ? String(tests[0].id) : '';
      selManage.value = firstId;
      selQB.value = firstId;
      if (firstId) await loadTestDetails(firstId);
    }

    // Apply theme early (works for both login + app)
    applyTheme(getTheme());

    // Boot if token exists
    if (getAdminToken()) {
      initAdmin();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</body>
</html>
