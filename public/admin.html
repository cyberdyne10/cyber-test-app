<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cyber Test â€“ Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="main-shell">
    <div class="futuristic-orb"></div>

    <div class="panel-glass">
      <div class="panel-header">
        <div>
          <div style="display:flex; align-items:center; gap:0.75rem;">
            <img src="logo-cyber-logic.png" alt="Cyber-Logic Networks" style="height:40px; border-radius:12px; background:#020617; padding:4px;" />
            <div>
              <div class="badge-chip">Teacher Console</div>
              <div class="panel-title mt-2">
                <span>Assessment</span><span class="accent">Control Room</span>
              </div>
            </div>
          </div>
          <div class="panel-subtitle">Define tests, seed question banks, and monitor student performance.</div>
        </div>
        <div class="text-end d-none d-md-block">
          <div class="info-chip">
            <span class="label">Visibility</span>
            <span class="value">Instructor Only</span>
          </div>
        </div>
      </div>

      <!-- Simple admin auth (front-end only) -->
      <div id="loginSection" class="mb-4">
        <div class="lock-banner mb-3">
          <strong>Secure Area.</strong> Only the instructor should know the access phrase.
        </div>
        <div class="mb-2">
          <label class="form-label">Admin Access Phrase</label>
          <input type="password" id="adminPassword" class="form-control" placeholder="Enter instructor phrase" />
        </div>
        <button id="loginBtn" class="btn btn-fx-primary mt-2">
          <span class="pulse-dot"></span>
          <span>Unlock Console</span>
        </button>
        <div id="loginError" class="text-danger mt-2" style="display:none; font-size:0.85rem;">Incorrect phrase. Try again.</div>
        <hr class="section-divider" />
      </div>

      <div id="adminContent" style="display:none;">
        <div class="row-grid mb-4">
          <div>
            <h3 class="h6 text-uppercase text-muted mb-3" style="letter-spacing:0.15em;">Admin Settings</h3>
            <div class="mb-3">
              <label class="form-label">Admin Access Phrase</label>
              <input id="adminPhraseSetting" class="form-control" placeholder="Enter new admin phrase" />
            </div>
            <button id="updateAdminPhraseBtn" class="btn btn-fx-secondary mb-4">Update Phrase</button>
          </div>

          <div>
            <h3 class="h6 text-uppercase text-muted mb-3" style="letter-spacing:0.15em;">Create Test</h3>
            <div class="mb-3">
              <label class="form-label">Test Name</label>
              <input id="testName" class="form-control" placeholder="e.g. Network Security 101" />
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea id="testDesc" class="form-control" placeholder="Short summary"></textarea>
            </div>
            <button id="createTestBtn" class="btn btn-fx-primary mb-4">
              <span class="pulse-dot"></span>
              <span>Create Test</span>
            </button>
          </div>

          <div>
            <h3 class="h6 text-uppercase text-muted mb-3" style="letter-spacing:0.15em;">Question Bank</h3>
            <div class="mb-3">
              <label class="form-label">Target Test</label>
              <select id="testsList" class="form-select"></select>
            </div>

            <div class="mb-3" id="questionList" style="max-height: 240px; overflow-y: auto; border-radius: 12px; border: 1px solid rgba(148,163,184,0.3); padding: 0.5rem 0.75rem; background: rgba(15,23,42,0.85);">
              <div class="text-muted" style="font-size:0.8rem;">Questions for this test will appear here. Tap one to edit.</div>
            </div>

            <div class="mb-2">
              <label class="form-label">Question Text</label>
              <textarea id="questionText" class="form-control" placeholder="Type the full question"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Options</label>
              <input id="opt1" class="form-control mb-1" placeholder="Option 1" />
              <input id="opt2" class="form-control mb-1" placeholder="Option 2" />
              <input id="opt3" class="form-control mb-1" placeholder="Option 3" />
              <input id="opt4" class="form-control mb-1" placeholder="Option 4" />
            </div>
            <div class="mb-3">
              <label class="form-label">Correct Option</label>
              <select id="correctOpt" class="form-select">
                <option value="1">Option 1</option>
                <option value="2">Option 2</option>
                <option value="3">Option 3</option>
                <option value="4">Option 4</option>
              </select>
            </div>
            <button id="addQuestionBtn" class="btn btn-fx-secondary mb-4">Add Question</button>
          </div>
        </div>

        <hr class="section-divider" />

        <h3 class="h6 text-uppercase text-muted mb-3" style="letter-spacing:0.15em;">Recent Attempts</h3>
        <div class="table-responsive">
          <table class="table table-dark table-borderless align-middle" style="background:transparent;">
            <thead style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.16em; color:#9ca3af;">
              <tr>
                <th>Student</th>
                <th>Student ID</th>
                <th>Test</th>
                <th>Score</th>
                <th>Total</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="attemptsBody" style="font-size:0.85rem;"></tbody>
          </table>
        </div>

        <div class="mt-3 d-flex justify-content-between align-items-center btn-row-stack">
          <a href="index.html" class="btn btn-fx-secondary">Back to Student View</a>
          <small class="text-muted">Table refreshes every 10 seconds.</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Simple admin password (front-end only).
    const DEFAULT_ADMIN_PASSWORD = 'CyberAdmin2025!';

    function getAdminPassword() {
      return localStorage.getItem('cln_admin_password') || DEFAULT_ADMIN_PASSWORD;
    }

    function setAdminPassword(newPwd) {
      localStorage.setItem('cln_admin_password', newPwd);
    }

    const loginSection = document.getElementById('loginSection');
    const adminContent = document.getElementById('adminContent');
    const loginError = document.getElementById('loginError');
    const loginBtn = document.getElementById('loginBtn');

    loginBtn.addEventListener('click', () => {
      const entered = document.getElementById('adminPassword').value;
      if (entered === getAdminPassword()) {
        loginSection.style.display = 'none';
        adminContent.style.display = 'block';
        loginError.style.display = 'none';
        initAdmin();
      } else {
        loginError.style.display = 'block';
      }
    });

    async function loadTests() {
      const res = await fetch('/api/tests');
      const tests = await res.json();
      const list = document.getElementById('testsList');
      list.innerHTML = '';
      tests.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        list.appendChild(opt);
      });

      if (tests.length) {
        await loadQuestionsForTest(tests[0].id);
      }

      list.addEventListener('change', async () => {
        const id = list.value;
        await loadQuestionsForTest(id);
        window.currentQuestionForEdit = null;
        document.getElementById('questionText').value = '';
        ['opt1','opt2','opt3','opt4'].forEach(id => document.getElementById(id).value = '');
      });
    }

    async function loadQuestionsForTest(testId) {
      const res = await fetch(`/api/tests/${testId}/questions-full`);
      const questions = await res.json();
      const container = document.getElementById('questionList');
      container.innerHTML = '';
      if (!questions.length) {
        container.innerHTML = '<div class="text-muted" style="font-size:0.8rem;">No questions yet for this test.</div>';
        return;
      }
      questions.forEach(q => {
        const item = document.createElement('div');
        item.className = 'mb-2 question-item';
        item.style.cursor = 'pointer';
        item.style.padding = '0.45rem 0.5rem';
        item.style.borderRadius = '8px';
        item.style.border = '1px solid rgba(30,64,175,0.4)';
        item.style.background = 'rgba(15,23,42,0.95)';
        item.textContent = q.text;
        item.addEventListener('click', () => {
          // populate editor with selected question
          document.getElementById('questionText').value = q.text;
          document.getElementById('opt1').value = q.options[0]?.text || '';
          document.getElementById('opt2').value = q.options[1]?.text || '';
          document.getElementById('opt3').value = q.options[2]?.text || '';
          document.getElementById('opt4').value = q.options[3]?.text || '';
          const correctIndex = q.options.findIndex(o => o.is_correct);
          if (correctIndex >= 0) {
            document.getElementById('correctOpt').value = (correctIndex + 1).toString();
          }
          // store current question id + options for update
          window.currentQuestionForEdit = q;
        });
        container.appendChild(item);
      });
    }

    async function loadAttempts() {
      const res = await fetch('/api/attempts');
      const attempts = await res.json();
      const body = document.getElementById('attemptsBody');
      body.innerHTML = '';
      attempts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.student_name}</td>
          <td>${a.student_id || ''}</td>
          <td>${a.test_name}</td>
          <td>${a.score}</td>
          <td>${a.total}</td>
          <td>${a.created_at}</td>
        `;
        body.appendChild(tr);
      });
    }

    function initAdmin() {
      document.getElementById('updateAdminPhraseBtn').addEventListener('click', () => {
        const val = document.getElementById('adminPhraseSetting').value.trim();
        if (!val) {
          alert('Enter a new admin phrase');
          return;
        }
        setAdminPassword(val);
        document.getElementById('adminPhraseSetting').value = '';
        alert('Admin phrase updated for this browser.');
      });

      document.getElementById('createTestBtn').addEventListener('click', async () => {
        const name = document.getElementById('testName').value.trim();
        const desc = document.getElementById('testDesc').value.trim();
        if (!name) {
          alert('Enter test name');
          return;
        }
        await fetch('/api/tests', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name, description: desc })
        });
        document.getElementById('testName').value = '';
        document.getElementById('testDesc').value = '';
        await loadTests();
        alert('Test created');
      });

      document.getElementById('addQuestionBtn').addEventListener('click', async () => {
        const testId = document.getElementById('testsList').value;
        const qText = document.getElementById('questionText').value.trim();
        if (!qText) {
          alert('Enter question text');
          return;
        }
        const opts = [
          document.getElementById('opt1').value.trim(),
          document.getElementById('opt2').value.trim(),
          document.getElementById('opt3').value.trim(),
          document.getElementById('opt4').value.trim()
        ];
        const correct = parseInt(document.getElementById('correctOpt').value, 10) - 1;

        const options = opts.map((t, idx) => ({
          text: t,
          is_correct: idx === correct
        }));

        await fetch(`/api/tests/${testId}/questions`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text: qText, options })
        });

        document.getElementById('questionText').value = '';
        ['opt1','opt2','opt3','opt4'].forEach(id => document.getElementById(id).value = '');
        alert('Question added');
      });

      loadTests();
      loadAttempts();
      setInterval(loadAttempts, 10000);
    }
  </script>
</body>
</html>
